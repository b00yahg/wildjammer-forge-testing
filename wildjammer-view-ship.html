<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Wildjammer Ship</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="wildjammer-data.js"></script>
    <script src="ship-class.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Space+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="spelljammer-style.css">
    <script src="theme-switcher.js" defer></script>
    <style>
        .editable:hover {
            background-color: rgba(255, 255, 255, 0.1);
            cursor: pointer;
        }
        .popup {
            display: none;
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            border-radius: 5px;
            z-index: 1000;
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
    </style>
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
</head>
<body class="light-mode">
    <div class="cosmic-dust"></div>
    <div class="container mx-auto px-4 py-8">
        <div class="mb-4 flex justify-between items-center">
            <a href="index.html" class="text-blue-500 hover:text-blue-400">Back to Ship List</a>
            <div>
                <button id="editModeToggle" class="px-4 py-2 rounded hover transition duration-300 mr-2">Toggle Edit Mode</button>
                <button id="toggleDarkMode" class="px-4 py-2 rounded hover transition duration-300">Toggle Dark Mode</button>
            </div>
        </div>

        <div id="shipSheet" class="ship-card rounded-lg p-6">
            <div class="grid grid-cols-3 gap-4 mb-4">
                <div class="col-span-2">
                    <h1 id="shipName" class="text-3xl font-bold editable">Ship Name</h1>
                </div>
                <div>
                    <p>Model: <span id="shipModel"></span></p>
                    <p>Size Classification: <span id="sizeClassification"></span></p>
                </div>
            </div>

            <div class="grid grid-cols-3 gap-4 mb-4">
                <div class="ship-card p-4 rounded">
                    <h2 class="text-xl font-bold mb-2">Crew</h2>
                    <ul>
                        <li>Captain: <span id="captain" class="editable"></span></li>
                        <li>Helmsman: <span id="helmsman" class="editable"></span></li>
                        <li>Boatswain: <span id="boatswain" class="editable"></span></li>
                        <li>Gunner 1: <span id="gunner1" class="editable"></span></li>
                        <li>Gunner 2: <span id="gunner2" class="editable"></span></li>
                        <li>Gunner 3: <span id="gunner3" class="editable"></span></li>
                        <li>Fighter Helmsman 1: <span id="fighterHelmsman1" class="editable"></span></li>
                        <li>Fighter Helmsman 2: <span id="fighterHelmsman2" class="editable"></span></li>
                        <li>Fighter Helmsman 3: <span id="fighterHelmsman3" class="editable"></span></li>
                    </ul>
                </div>
                <div class="col-span-2">
                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <div class="ship-card p-4 rounded text-center">
                            <h3 class="font-bold">Maneuverability</h3>
                            <p id="maneuverability" class="editable">-</p>
                        </div>
                        <div class="ship-card p-4 rounded text-center">
                            <h3 class="font-bold">Tactical Speed</h3>
                            <p id="tacticalSpeed" class="editable">-</p>
                        </div>
                        <div class="ship-card p-4 rounded text-center">
                            <h3 class="font-bold">Hover Speed</h3>
                            <p id="hoverSpeed" class="editable">-</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="ship-card p-4 rounded text-center">
                            <h3 class="font-bold">Bulwark Points</h3>
                            <p id="bulwarkPoints" class="editable">-</p>
                        </div>
                        <div class="ship-card p-4 rounded text-center">
                            <h3 class="font-bold">Hull Points</h3>
                            <div class="hull-points-control flex justify-center items-center">
                                <button id="decreaseHP" class="px-2 py-1 bg-red-600 text-white rounded mr-2">-</button>
                                <input type="number" id="hullPoints" class="w-16 text-center bg-gray-800 rounded" value="0">
                                <button id="increaseHP" class="px-2 py-1 bg-green-600 text-white rounded ml-2">+</button>
                            </div>
                        </div>
                        <div class="ship-card p-4 rounded text-center">
                            <h3 class="font-bold">Armor Class</h3>
                            <p id="armorClass" class="editable">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-4">
                <h2 class="text-2xl font-bold mb-2">Helm</h2>
                <div id="helmInfo" class="ship-card p-4 rounded">
                    <h3 id="helmName" class="font-bold">-</h3>
                    <p id="helmDescription">-</p>
                </div>
            </div>

            <div>
                <h2 class="text-2xl font-bold mb-2">Crew Complement</h2>
                <div id="crewComplementTable"></div>
            </div>

            <div>
                <h2 class="text-2xl font-bold mb-2">Modules</h2>
                <ul id="modulesList">
                    <!-- Modules will be added here dynamically -->
                </ul>
                <button id="addModule" class="mt-2 px-4 py-2 rounded hover transition duration-300">Add Module</button>
             </div>

            <div class="mb-4">
                <h2 class="text-2xl font-bold mb-2">Weapons</h2>
                <table class="w-full">
                    <thead>
                        <tr>
                            <th>Weapon</th>
                            <th>Attack Bonus</th>
                            <th>Mega Damage</th>
                            <th>Range/Facing</th>
                            <th>Hull Points</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="weaponsList">
                        <!-- Weapons will be added here dynamically -->
                    </tbody>
                </table>
                <button id="addWeapon" class="mt-2 px-4 py-2 rounded hover transition duration-300">Add Weapon</button>
            </div>

            <div class="mb-4">
                <h2 class="text-2xl font-bold mb-2">Ship Features and Upgrades</h2>
                <ul id="upgradesList">
                    <!-- Upgrades will be added here dynamically -->
                </ul>
                <button id="addUpgrade" class="mt-2 px-4 py-2 rounded hover transition duration-300">Add Upgrade</button>
            </div>

            <div class="mb-4">
                <h2 class="text-2xl font-bold mb-2">Cargo Storage</h2>
                <div class="grid grid-cols-4 gap-4">
                    <div>
                        <label for="copperInput">Copper:</label>
                        <input type="number" id="copperInput" class="w-full rounded p-1" value="0">
                    </div>
                    <div>
                        <label for="silverInput">Silver:</label>
                        <input type="number" id="silverInput" class="w-full rounded p-1" value="0">
                    </div>
                    <div>
                        <label for="goldInput">Gold:</label>
                        <input type="number" id="goldInput" class="w-full rounded p-1" value="0">
                    </div>
                    <div>
                        <label for="platinumInput">Platinum:</label>
                        <input type="number" id="platinumInput" class="w-full rounded p-1" value="0">
                    </div>
                </div>
                <div class="mt-4">
                    <label for="cargoItems">Cargo Items:</label>
                    <textarea id="cargoItems" class="w-full rounded p-2" rows="4"></textarea>
                </div>
            </div>
        </div>
    </div>

    <div id="popup" class="popup">
        <h2 class="text-2xl font-bold mb-2">Dice Roll Result</h2>
        <p id="rollResult"></p>
        <button id="closePopup" class="mt-4 px-4 py-2 rounded hover transition duration-300">Close</button>
    </div>

    <div id="overlay" class="overlay"></div>
        <script>
        let currentShip;
        let editMode = false;
    
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const shipId = urlParams.get('id');
            loadShip(shipId);
    
            document.getElementById('editModeToggle').addEventListener('click', toggleEditMode);
            document.getElementById('toggleDarkMode').addEventListener('click', toggleDarkMode);
            document.getElementById('decreaseHP').addEventListener('click', () => adjustHullPoints(-1));
            document.getElementById('increaseHP').addEventListener('click', () => adjustHullPoints(1));
            document.getElementById('addModule').addEventListener('click', showModuleDropdown);
            document.getElementById('addWeapon').addEventListener('click', showWeaponDropdown);
            document.getElementById('addUpgrade').addEventListener('click', showUpgradeDropdown);
            document.getElementById('closePopup').addEventListener('click', closePopup);
    
            document.getElementById('confirmAddModule').addEventListener('click', confirmAddModule);
            document.getElementById('cancelAddModule').addEventListener('click', hideModuleDropdown);
            document.getElementById('confirmAddWeapon').addEventListener('click', confirmAddWeapon);
            document.getElementById('cancelAddWeapon').addEventListener('click', hideWeaponDropdown);
            document.getElementById('confirmAddUpgrade').addEventListener('click', confirmAddUpgrade);
            document.getElementById('cancelAddUpgrade').addEventListener('click', hideUpgradeDropdown);
    
            // Add event listeners for cargo inputs
            ['copperInput', 'silverInput', 'goldInput', 'platinumInput', 'cargoItems'].forEach(id => {
                document.getElementById(id).addEventListener('change', saveShipChanges);
            });
    
            // Populate dropdowns
            populateDropdown('moduleSelect', wildjammerData.modules);
            populateDropdown('weaponSelect', wildjammerData.weapons);
            populateDropdown('upgradeSelect', wildjammerData.upgrades);
        });   
              function loadShip(shipId) {
                const ships = JSON.parse(localStorage.getItem('wildjammerShips')) || {};
                const shipData = ships[shipId];
                if (shipData) {
                    currentShip = new Ship(shipData);
                    console.log('Loaded ship:', currentShip);
                    
                    // Ensure weaponModifiers is initialized
                    currentShip.weaponModifiers = currentShip.weaponModifiers || {};
                    
                    // Reapply all upgrades
                    currentShip.upgrades.forEach(upgradeKey => {
                        applyUpgradeEffect(upgradeKey, true);
                    });
                } else {
                    console.error('Ship not found in localStorage');
                    window.location.href = 'create-ship.html';
                    return;
                }
                updateShipDisplay();
            }
        
            function updateShipDisplay() {
                document.getElementById('shipName').textContent = currentShip.name;
                document.getElementById('shipModel').textContent = currentShip.hullType;
                document.getElementById('sizeClassification').textContent = `${currentShip.size[0]}x${currentShip.size[1]}`;
                document.getElementById('captain').textContent = currentShip.captain;
                document.getElementById('helmsman').textContent = currentShip.helmsman;
                document.getElementById('boatswain').textContent = currentShip.boatswain;
                document.getElementById('gunner1').textContent = currentShip.gunner1;
                document.getElementById('gunner2').textContent = currentShip.gunner2;
                document.getElementById('gunner3').textContent = currentShip.gunner3;
                document.getElementById('fighterHelmsman1').textContent = currentShip.fighterHelmsman1;
                document.getElementById('fighterHelmsman2').textContent = currentShip.fighterHelmsman2;
                document.getElementById('fighterHelmsman3').textContent = currentShip.fighterHelmsman3;
                document.getElementById('maneuverability').textContent = currentShip.maneuverability;
                const gridMovement = Math.floor(currentShip.speed / 500);
                document.getElementById('tacticalSpeed').textContent = `${currentShip.speed} (${gridMovement} grids)`;
                document.getElementById('hoverSpeed').textContent = "20 mph";
                document.getElementById('bulwarkPoints').textContent = currentShip.bp;
                document.getElementById('hullPoints').value = currentShip.hp;
                document.getElementById('armorClass').textContent = currentShip.ac;
                renderCrewComplementTable();
        
                // Update helm information
                const helmInfo = wildjammerData.helms[currentShip.helmType];
                document.getElementById('helmName').textContent = helmInfo.name;
                document.getElementById('helmDescription').textContent = helmInfo.description;
        
                // Update weapons list
                updateWeaponsList();
        
                // Update modules list
                updateModulesList();
        
                // Update upgrades list
                updateUpgradesList();
        
                // Update cargo information
                document.getElementById('copperInput').value = currentShip.cargo.copper;
                document.getElementById('silverInput').value = currentShip.cargo.silver;
                document.getElementById('goldInput').value = currentShip.cargo.gold;
                document.getElementById('platinumInput').value = currentShip.cargo.platinum;
                document.getElementById('cargoItems').value = currentShip.cargo.items;

                // Update weapons list
                updateWeaponsList();
                
                // Update modules list
                updateModulesList();
                
                // Update upgrades list
                updateUpgradesList();
            }
            
            function renderCrewComplementTable() {
                const root = ReactDOM.createRoot(document.getElementById('crewComplementTable'));
                root.render(React.createElement(CrewComplementTable, {
                    crewComplement: currentShip.crewComplement,
                    onCrewChange: (index, newCount) => {
                        currentShip.crewComplement[index].count = newCount;
                        saveShipChanges();
                    },
                    onAddCustomCrew: (newCrew) => {
                        currentShip.crewComplement.push({ ...newCrew, count: 0 });
                        saveShipChanges();
                        renderCrewComplementTable();
                    }
                }));
            }
            
            function updateCrewTotals() {
                const crewTypes = [
                    { dayRate: 1.5, monthRate: 45 },
                    { dayRate: 3, monthRate: 90 },
                    { dayRate: 5, monthRate: 150 },
                    { dayRate: 6.5, monthRate: 195 },
                    { dayRate: 8, monthRate: 240 }
                ];
            
                const rows = document.getElementById('crewComplementTable').rows;
                let totalDay = 0;
                let totalMonth = 0;
            
                for (let i = 0; i < rows.length; i++) {
                    const count = parseInt(rows[i].querySelector('.crew-count').value) || 0;
                    const dayTotal = count * crewTypes[i].dayRate;
                    const monthTotal = count * crewTypes[i].monthRate;
            
                    rows[i].querySelector('.total-day').textContent = dayTotal.toFixed(2) + 'gp';
                    rows[i].querySelector('.total-month').textContent = monthTotal.toFixed(2) + 'gp';
            
                    totalDay += dayTotal;
                    totalMonth += monthTotal;
            
                    // Update the currentShip object
                    if (!currentShip.crewComplement) currentShip.crewComplement = [];
                    currentShip.crewComplement[i] = { count: count };
                }
            
                // You can add total rows here if needed
            
                saveShipChanges();
            }
            function updateWeaponsList() {
                console.log('Updating weapons list:', currentShip.weapons);
                const weaponsList = document.getElementById('weaponsList');
                weaponsList.innerHTML = '';
                
                currentShip.weapons.forEach((weaponKey, index) => {
                    const weapon = wildjammerData.weapons[weaponKey];
                    if (weapon) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="text-left py-2">${weapon.name}</td>
                            <td class="text-center py-2">
                                <input type="number" class="rounded p-1 w-16 text-center weapon-to-hit" value="${currentShip.weaponModifiers?.[weaponKey]?.toHit || 0}" data-index="${index}">
                            </td>
                            <td class="text-center py-2">
                                ${weapon.damage} + 
                                <input type="number" class="rounded p-1 w-16 text-center weapon-damage-modifier" value="${currentShip.weaponModifiers?.[weaponKey]?.damage || 0}" data-index="${index}">
                            </td>
                            <td class="text-center py-2">${weapon.range.normal}/${weapon.range.long}</td>
                            <td class="text-center py-2">
                                <div class="flex items-center justify-center">
                                    <button class="px-2 py-1 bg-red-600 text-white rounded mr-2" onclick="adjustWeaponHP(${index}, -1)">-</button>
                                    <input type="number" class="rounded p-1 w-16 text-center weapon-hp" value="${currentShip.weaponModifiers?.[weaponKey]?.hp || 10}" data-index="${index}" readonly>
                                    <button class="px-2 py-1 bg-green-600 text-white rounded ml-2" onclick="adjustWeaponHP(${index}, 1)">+</button>
                                </div>
                            </td>
                            <td class="text-center py-2">
                                <button class="px-2 py-1 rounded mr-2" onclick="rollWeaponAttack(${index})">Roll</button>
                                <button class="px-2 py-1 rounded" onclick="removeWeapon(${index})">Remove</button>
                            </td>
                        `;
                        weaponsList.appendChild(row);
                    } else {
                        console.error(`Weapon not found: ${weaponKey}`);
                    }
                });
            }
            function adjustWeaponHP(index, amount) {
                const weaponKey = currentShip.weapons[index];
                if (!currentShip.weaponModifiers) currentShip.weaponModifiers = {};
                if (!currentShip.weaponModifiers[weaponKey]) currentShip.weaponModifiers[weaponKey] = {};
                currentShip.weaponModifiers[weaponKey].hp = (currentShip.weaponModifiers[weaponKey].hp || 10) + amount;
                updateWeaponsList();
                saveShipChanges();
            }
            function updateModulesList() {
                console.log('Updating modules list:', currentShip.modules);
                const modulesList = document.getElementById('modulesList');
                modulesList.innerHTML = '';
                currentShip.modules.forEach((moduleKey, index) => {
                    const module = wildjammerData.modules[moduleKey];
                    if (module) {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <strong>${module.name}</strong>
                            <p>${module.description}</p>
                            ${module.uses ? `
                                <div class="module-uses" data-index="${index}">
                                    <label>Uses: 
                                        <input type="number" class="rounded p-1 w-16 text-center module-use-count" 
                                               value="${currentShip.moduleUses?.[moduleKey] || 0}" 
                                               min="0" max="${module.uses.max}" data-index="${index}">
                                        / ${module.uses.max} per ${module.uses.per}
                                    </label>
                                </div>
                            ` : ''}
                            <button class="px-2 py-1 bg-red-600 text-white rounded mt-2" onclick="removeModule(${index})">Remove</button>
                        `;
                        modulesList.appendChild(li);
                    } else {
                        console.error(`Module not found: ${moduleKey}`);
                    }
                });
            }
            function updateUpgradesList() {
                console.log('Updating upgrades list:', currentShip.upgrades);
                const upgradesList = document.getElementById('upgradesList');
                upgradesList.innerHTML = '';
                currentShip.upgrades.forEach((upgradeKey, index) => {
                    const upgrade = wildjammerData.upgrades[upgradeKey];
                    if (upgrade) {
                        const li = document.createElement('li');
                        li.className = 'mb-4';
                        li.innerHTML = `
                            <strong class="block mb-1">${upgrade.name}</strong>
                            <p class="mb-2">${upgrade.description}</p>
                            <button class="px-2 py-1 bg-red-600 text-white rounded" onclick="removeUpgrade(${index})">Remove</button>
                        `;
                        upgradesList.appendChild(li);
                    } else {
                        console.error(`Upgrade not found: ${upgradeKey}`);
                    }
                });
            }
        
            function toggleEditMode() {
                editMode = !editMode;
                document.querySelectorAll('.editable').forEach(el => {
                    el.contentEditable = editMode;
                });
                document.getElementById('editModeToggle').textContent = editMode ? 'Save Changes' : 'Toggle Edit Mode';
                if (!editMode) {
                    saveShipChanges();
                }
            }
        
            function adjustHullPoints(amount) {
                const hullPointsInput = document.getElementById('hullPoints');
                hullPointsInput.value = parseInt(hullPointsInput.value) + amount;
                saveShipChanges();
            }
        
            function addModule() {
                const moduleKey = prompt('Enter module key:');
                if (moduleKey && wildjammerData.modules[moduleKey]) {
                    currentShip.addModule(moduleKey);
                    updateModulesList();
                    saveShipChanges();
                } else {
                    alert('Invalid module key');
                }
            }
        
            function removeModule(index) {
                currentShip.removeModule(index);
                updateModulesList();
                saveShipChanges();
            }
        
            function addWeapon() {
                const weaponKey = prompt('Enter weapon key:');
                if (weaponKey && wildjammerData.weapons[weaponKey]) {
                    currentShip.addWeapon(weaponKey);
                    updateWeaponsList();
                    saveShipChanges();
                } else {
                    alert('Invalid weapon key');
                }
            }
        
            function removeWeapon(index) {
                currentShip.removeWeapon(index);
                updateWeaponsList();
                saveShipChanges();
            }
        
            function addUpgrade() {
                const upgradeKey = prompt('Enter upgrade key:');
                if (upgradeKey && wildjammerData.upgrades[upgradeKey]) {
                    currentShip.addUpgrade(upgradeKey);
                    applyUpgradeEffect(upgradeKey, true);
                    updateUpgradesList();
                    updateShipDisplay();
                    saveShipChanges();
                } else {
                    alert('Invalid upgrade key');
                }
            }
        
            function removeUpgrade(index) {
                const upgradeKey = currentShip.upgrades[index];
                currentShip.upgrades.splice(index, 1); // Remove the upgrade from the array
                applyUpgradeEffect(upgradeKey, false);
                updateUpgradesList();
                updateShipDisplay();
                saveShipChanges();
            }
        
            function applyUpgradeEffect(upgradeKey, isAdding) {
                const upgrade = wildjammerData.upgrades[upgradeKey];
                if (upgrade && upgrade.effect) {
                    if (isAdding) {
                        upgrade.effect(currentShip);
                    } else {
                        // Reverse the effect when removing
                        const reverseEffect = (ship) => {
                            switch (upgrade.name) {
                                case "Enchanted Hull":
                                    ship.ac -= 1;
                                    break;
                                case "Reinforced Hull":
                                    ship.hp -= 16;
                                    break;
                                case "Adaptable Sails":
                                    ship.maneuverability -= 45;
                                    break;
                                case "Gliding Sails":
                                    ship.speed -= 500;
                                    break;
                                case "Reinforced Bulwark":
                                    ship.bp -= 8;
                                    break;
                                // Add cases for other upgrades that modify stats
                                default:
                                    console.warn(`No reverse effect defined for upgrade: ${upgrade.name}`);
                            }
                        };
                        reverseEffect(currentShip);
                    }
                }
                console.log('Applied upgrade effect:', upgradeKey, isAdding, currentShip);
                updateShipDisplay(); // Ensure the display is updated after applying/removing upgrades
            }
        
            function rollWeaponAttack(index) {
                const weapon = wildjammerData.weapons[currentShip.weapons[index]];
                const toHitModifier = parseInt(document.querySelector(`.weapon-to-hit[data-index="${index}"]`).value) || 0;
                const damageModifier = parseInt(document.querySelector(`.weapon-damage-modifier[data-index="${index}"]`).value) || 0;
        
                const toHitRoll = Math.floor(Math.random() * 20) + 1;
                const totalToHit = toHitRoll + toHitModifier;
        
                const damageRoll = rollDice(weapon.damage);
                const totalDamage = damageRoll + damageModifier;
        
                const result = `To hit: ${toHitRoll} + ${toHitModifier} = ${totalToHit}<br>Damage: ${damageRoll} + ${damageModifier} = ${totalDamage} ${weapon.type} damage`;
        
                showPopup(result);
            }
        
            function rollDice(diceNotation) {
                const [count, sides] = diceNotation.split('d').map(Number);
                let total = 0;
                for (let i = 0; i < count; i++) {
                    total += Math.floor(Math.random() * sides) + 1;
                }
                return total;
            }
        
            function showPopup(content) {
                document.getElementById('rollResult').innerHTML = content;
                document.getElementById('popup').style.display = 'block';
                document.getElementById('overlay').style.display = 'block';
            }
        
            function closePopup() {
                document.getElementById('popup').style.display = 'none';
                document.getElementById('overlay').style.display = 'none';
            }
        
            function saveShipChanges() {
                // Update currentShip object with edited values
                currentShip.name = document.getElementById('shipName').textContent;
                currentShip.captain = document.getElementById('captain').textContent;
                currentShip.helmsman = document.getElementById('helmsman').textContent;
                currentShip.boatswain = document.getElementById('boatswain').textContent;
                currentShip.gunner1 = document.getElementById('gunner1').textContent;
                currentShip.gunner2 = document.getElementById('gunner2').textContent;
                currentShip.gunner3 = document.getElementById('gunner3').textContent;
                currentShip.fighterHelmsman1 = document.getElementById('fighterHelmsman1').textContent;
                currentShip.fighterHelmsman2 = document.getElementById('fighterHelmsman2').textContent;
                currentShip.fighterHelmsman3 = document.getElementById('fighterHelmsman3').textContent;
                currentShip.maneuverability = parseInt(document.getElementById('maneuverability').textContent);
                currentShip.speed = parseInt(document.getElementById('tacticalSpeed').textContent.split(' ')[0]);
                currentShip.bp = parseInt(document.getElementById('bulwarkPoints').textContent);
                currentShip.hp = parseInt(document.getElementById('hullPoints').value);
                currentShip.ac = parseInt(document.getElementById('armorClass').textContent);
            
                currentShip.cargo = {
                    copper: parseInt(document.getElementById('copperInput').value) || 0,
                    silver: parseInt(document.getElementById('silverInput').value) || 0,
                    gold: parseInt(document.getElementById('goldInput').value) || 0,
                    platinum: parseInt(document.getElementById('platinumInput').value) || 0,
                    items: document.getElementById('cargoItems').value
                };
            
                // Save weapon modifiers and HP
                currentShip.weaponModifiers = {};
                currentShip.weapons.forEach((weaponKey, index) => {
                    const toHitModifier = parseInt(document.querySelector(`.weapon-to-hit[data-index="${index}"]`)?.value) || 0;
                    const damageModifier = parseInt(document.querySelector(`.weapon-damage-modifier[data-index="${index}"]`)?.value) || 0;
                    const hp = parseInt(document.querySelector(`.weapon-hp[data-index="${index}"]`)?.value) || 10;
                    currentShip.weaponModifiers[weaponKey] = { toHit: toHitModifier, damage: damageModifier, hp: hp };
                });
            
                // Save module uses
                currentShip.moduleUses = {};
                currentShip.modules.forEach((moduleKey, index) => {
                    const module = wildjammerData.modules[moduleKey];
                    if (module && module.uses) {
                        const useCountInput = document.querySelector(`.module-use-count[data-index="${index}"]`);
                        const usedCount = parseInt(useCountInput?.value) || 0;
                        currentShip.moduleUses[moduleKey] = usedCount;
                    }
                });
            
                // Save crew complement data
                currentShip.crewComplement = currentShip.crewComplement.map(crew => ({
                    type: crew.type,
                    count: crew.count,
                    dayRate: crew.dayRate,
                    monthRate: crew.monthRate
                }));
                // Save updated ship to localStorage
                const ships = JSON.parse(localStorage.getItem('wildjammerShips')) || {};
                ships[currentShip.id] = currentShip.toJSON();
                localStorage.setItem('wildjammerShips', JSON.stringify(ships));
                console.log('Ship changes saved:', currentShip);
            }
            
            function populateDropdown(selectId, data) {
                const select = document.getElementById(selectId);
                select.innerHTML = '';
                for (const [key, value] of Object.entries(data)) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = value.name;
                    select.appendChild(option);
                }
            }
            
        function showModuleDropdown() {
            document.getElementById('moduleDropdown').style.display = 'block';
        }
    
        function hideModuleDropdown() {
            document.getElementById('moduleDropdown').style.display = 'none';
        }
            
                function confirmAddModule() {
                    const moduleKey = document.getElementById('moduleSelect').value;
                    if (moduleKey && wildjammerData.modules[moduleKey]) {
                        currentShip.addModule(moduleKey);
                        updateModulesList();
                        saveShipChanges();
                        hideModuleDropdown();
                    } else {
                        alert('Invalid module selection');
                    }
                }
            
        function showWeaponDropdown() {
            document.getElementById('weaponDropdown').style.display = 'block';
        }
    
        function hideWeaponDropdown() {
            document.getElementById('weaponDropdown').style.display = 'none';
        }
            
                function confirmAddWeapon() {
                    const weaponKey = document.getElementById('weaponSelect').value;
                    if (weaponKey && wildjammerData.weapons[weaponKey]) {
                        currentShip.addWeapon(weaponKey);
                        updateWeaponsList();
                        saveShipChanges();
                        hideWeaponDropdown();
                    } else {
                        alert('Invalid weapon selection');
                    }
                }
            
        function showUpgradeDropdown() {
            document.getElementById('upgradeDropdown').style.display = 'block';
        }
    
        function hideUpgradeDropdown() {
            document.getElementById('upgradeDropdown').style.display = 'none';
        }
            
                function confirmAddUpgrade() {
                    const upgradeKey = document.getElementById('upgradeSelect').value;
                    if (upgradeKey && wildjammerData.upgrades[upgradeKey]) {
                        currentShip.addUpgrade(upgradeKey);
                        applyUpgradeEffect(upgradeKey, true);
                        updateUpgradesList();
                        updateShipDisplay();
                        saveShipChanges();
                        hideUpgradeDropdown();
                    } else {
                        alert('Invalid upgrade selection');
                    }
                }
        const CrewComplementTable = ({ crewComplement, onCrewChange, onAddCustomCrew }) => {
            const [showCustomCrewForm, setShowCustomCrewForm] = React.useState(false);
            const [customCrewName, setCustomCrewName] = React.useState('');
            const [customCrewDayRate, setCustomCrewDayRate] = React.useState('');
            const [customCrewMonthRate, setCustomCrewMonthRate] = React.useState('');
        
            const handleAddCustomCrew = () => {
                if (customCrewName && customCrewDayRate && customCrewMonthRate) {
                    onAddCustomCrew({
                        type: customCrewName,
                        dayRate: parseFloat(customCrewDayRate),
                        monthRate: parseFloat(customCrewMonthRate)
                    });
                    setShowCustomCrewForm(false);
                    setCustomCrewName('');
                    setCustomCrewDayRate('');
                    setCustomCrewMonthRate('');
                }
            };
        
            return React.createElement('div', null, [
                React.createElement('table', { className: "w-full", key: "table" }, [
                    React.createElement('thead', { key: "thead" }, 
                        React.createElement('tr', null, [
                            React.createElement('th', { key: "th1" }, "Type of Crew"),
                            React.createElement('th', { key: "th2" }, "#"),
                            React.createElement('th', { key: "th3" }, "Rate (Day/Month)"),
                            React.createElement('th', { key: "th4" }, "Total (Day)"),
                            React.createElement('th', { key: "th5" }, "Total (Month)")
                        ])
                    ),
                    React.createElement('tbody', { key: "tbody" }, 
                        crewComplement.map((crew, index) => 
                            React.createElement('tr', { key: index }, [
                                React.createElement('td', { key: "td1" }, crew.type),
                                React.createElement('td', { key: "td2" }, 
                                    React.createElement('input', {
                                        type: "number",
                                        value: crew.count,
                                        onChange: (e) => onCrewChange(index, parseInt(e.target.value)),
                                        min: "0",
                                        className: "w-16 text-center"
                                    })
                                ),
                                React.createElement('td', { key: "td3" }, `${crew.dayRate}gp / ${crew.monthRate}gp`),
                                React.createElement('td', { key: "td4" }, `${(crew.count * crew.dayRate).toFixed(2)}gp`),
                                React.createElement('td', { key: "td5" }, `${(crew.count * crew.monthRate).toFixed(2)}gp`)
                            ])
                        )
                    )
                ]),
                !showCustomCrewForm && React.createElement('button', {
                    onClick: () => setShowCustomCrewForm(true),
                    className: "mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition duration-300",
                    key: "addButton"
                }, "Add Custom Crew Type"),
                showCustomCrewForm && React.createElement('div', { className: "mt-4 p-4 border rounded", key: "form" }, [
                    React.createElement('h3', { className: "mb-2", key: "formTitle" }, "Add Custom Crew Type"),
                    React.createElement('div', { className: "mb-2", key: "nameInput" }, [
                        React.createElement('label', { htmlFor: "customCrewName", key: "nameLabel" }, "Crew Name"),
                        React.createElement('input', {
                            id: "customCrewName",
                            value: customCrewName,
                            onChange: (e) => setCustomCrewName(e.target.value),
                            placeholder: "e.g., Elite Guards",
                            className: "w-full p-2 border rounded",
                            key: "nameField"
                        })
                    ]),
                    React.createElement('div', { className: "mb-2", key: "dayRateInput" }, [
                        React.createElement('label', { htmlFor: "customCrewDayRate", key: "dayRateLabel" }, "Day Rate (gp)"),
                        React.createElement('input', {
                            id: "customCrewDayRate",
                            type: "number",
                            value: customCrewDayRate,
                            onChange: (e) => setCustomCrewDayRate(e.target.value),
                            placeholder: "e.g., 10",
                            className: "w-full p-2 border rounded",
                            key: "dayRateField"
                        })
                    ]),
                    React.createElement('div', { className: "mb-2", key: "monthRateInput" }, [
                        React.createElement('label', { htmlFor: "customCrewMonthRate", key: "monthRateLabel" }, "Month Rate (gp)"),
                        React.createElement('input', {
                            id: "customCrewMonthRate",
                            type: "number",
                            value: customCrewMonthRate,
                            onChange: (e) => setCustomCrewMonthRate(e.target.value),
                            placeholder: "e.g., 300",
                            className: "w-full p-2 border rounded",
                            key: "monthRateField"
                        })
                    ]),
                    React.createElement('button', {
                        onClick: handleAddCustomCrew,
                        className: "px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition duration-300 mr-2",
                        key: "submitButton"
                    }, "Add Custom Crew"),
                    React.createElement('button', {
                        onClick: () => setShowCustomCrewForm(false),
                        className: "px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition duration-300",
                        key: "cancelButton"
                    }, "Cancel")
                ])
            ]);
        };

        </script>
    <div id="moduleDropdown" class="hidden fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-gray-800 p-4 rounded shadow-lg">
        <select id="moduleSelect" class="w-full p-2 bg-gray-700 text-white rounded">
            <!-- Options will be populated dynamically -->
        </select>
        <div class="mt-4 flex justify-end">
            <button id="confirmAddModule" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition duration-300 mr-2">Add</button>
            <button id="cancelAddModule" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition duration-300">Cancel</button>
        </div>
    </div>
    
    <div id="weaponDropdown" class="hidden fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-gray-800 p-4 rounded shadow-lg">
        <select id="weaponSelect" class="w-full p-2 bg-gray-700 text-white rounded">
            <!-- Options will be populated dynamically -->
        </select>
        <div class="mt-4 flex justify-end">
            <button id="confirmAddWeapon" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition duration-300 mr-2">Add</button>
            <button id="cancelAddWeapon" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition duration-300">Cancel</button>
        </div>
    </div>
    
    <div id="upgradeDropdown" class="hidden fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-gray-800 p-4 rounded shadow-lg">
        <select id="upgradeSelect" class="w-full p-2 bg-gray-700 text-white rounded">
            <!-- Options will be populated dynamically -->
        </select>
        <div class="mt-4 flex justify-end">
            <button id="confirmAddUpgrade" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition duration-300 mr-2">Add</button>
            <button id="cancelAddUpgrade" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition duration-300">Cancel</button>
        </div>
    </div>
</body>
</html>
